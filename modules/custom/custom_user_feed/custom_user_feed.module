<?php
use Drupal\Component\Utility\Html;
use Drupal\Component\Utility\Xss;
use Drush\Drush;
use Drupal\Core\Site\Settings;
use Drupal\paragraphs\Entity\Paragraph;
use Drupal\file\Entity\File;
use Drupal\media\Entity\Media;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\views\ViewExecutable;
use Drupal\Core\Render\Markup;

/**
 * Implements hook_views_pre_view().
 */
function custom_user_feed_views_pre_view(ViewExecutable $view, $display_id, array &$args) {
/*
  if ($view->id() == 'library_specialist' && $display_id == 'block_1') {
dpm('hmm');
    $contextual_filter_value = 'heidisb'; 

    $args[0] = $contextual_filter_value; 

  }
*/
}

/*
This module imports library staff users as paragraph entities
data is generated by the main staff site
*/

/*//a test user for reference:
stdClass Object
(
    [field_user_empid] => 36420892
    [uid] => 5
    [uniqname] => bertrama
    [field_user_first_name] => Albert
    [field_user_last_name] => Bertram
    [field_user_display_name] => Albert Bertram
    [field_user_official_title] => Web Applications Team Manager
    [field_user_phone] =>
    [field_user_photo_display] =>   <img loading="lazy" src="/sites/staff.lib.umich.edu/files/picture-5.jpg" width="150" height="225" alt="Albert Bertram&#039;s Photo" />


    [field_user_work_title] => Web Applications Team Leader
    [department_id] => 470440
    [department] => 2175, 49741
    [supervisor] => elynema
    [roles] => Administrator, Library Staff, Human Resources, Supervisor
    [field_user_non_student_temp] => 0
    [field_user_student_temp] => 0
    [status] => 1
    [uuid] => ae9f7f74-27bd-4dcd-bb17-520fb27c88eb
    [field_ptf_proxy] =>
    [field_turn_off_ptf_notifications] => 0
    [field_user_room] =>
    [field_physical_address_public_] => 0
    [field_user_office] => <p>Library Information Technology<br />
407 Hatcher North<br />
Ann Arbor, MI 48109-1190</p>

    [field_office_location] =>
    [field_languages_spoken] => en
    [field_user_academic_discipline] => 135, 413, 411, 409
    [field_user_library_expertise] => 10421
*/

//do users for sub sites
function _custom_user_feed() {

  $user_file = Settings::get('s3fs.file_e2', '');
  $recipient = 'eliotwsc@umich.edu';
  $reply_to = \Drupal::config('system.site')->get('mail');
  $users_report = [];

  //Get json data and decode properly
  $user_data = _custom_s3_get_data($user_file);
  $encoding = mb_detect_encoding($user_data, 'UTF-8', true);
  if ($encoding) {
    $user_data = mb_convert_encoding($user_data, 'UTF-8', $encoding);
  }
  if (empty($user_data)) {
    Drush::output()->writeln('ERROR WE DONT HAVE A FILE!');
    custom_uml_mail_send_mail($recipient, $reply_to, 'SUB SITE USER FEED - WE DONT HAVE A FILE!', 'error', 'custom_users_depts_error');
    exit;
  }
  Drush::output()->writeln('Loading File from '.$user_file);
  $user_data = json_decode($user_data);

  foreach ($user_data as $data) {
    if (empty($data->uniqname)) { continue; }
    $query = \Drupal::entityQuery('paragraph')
      ->accessCheck(FALSE)
      ->condition('type', 'library_staff')
      ->condition('field_uniqname', $data->uniqname);
    $paragraph = $query->execute();

    if (count($paragraph) > 1) {
      $users_error[] = Markup::create('<p>More than one paragraph for '.$data->uniqname.'</p>');
      custom_uml_mail_send_mail($recipient, $reply_to, 'Extra paragraph!', $users_error, 'custom_subsites_users_report');
    }
    if (empty($paragraph)) {
      if ($data->status == 0 || $data->field_user_non_student_temp == 1 || $data->field_user_student_temp == 1) {
        continue;
      }
      $users_report[] = Markup::create('<p>Create a new paragraph for '.$data->uniqname.'</p>');
      Drush::output()->writeln('Create a new paragraph for '.$data->uniqname);
      $paragraph = Paragraph::create([
        'type' => 'library_staff',
      ]);
    }
    else {
      $pid = array_values($paragraph)[0];
      $paragraph = Paragraph::load($pid);
    }

    $paragraph->get('field_display_name')->setValue([$data->field_user_display_name]);
    $paragraph->get('field_email')->setValue([$data->uniqname.'@umich.edu']);
    $paragraph->get('field_make_an_appointment')->setValue([$data->field_user_make_an_appointment]);
    $paragraph->get('field_uniqname')->setValue([$data->uniqname]);
    $specialist_term_ids = array_merge(
      explode(',',str_replace(' ', '',$data->field_user_academic_discipline)),
      explode(',',str_replace(' ', '',$data->field_user_library_expertise))
    );
    $specialist_terms = [];
    foreach ($specialist_term_ids as $term_id) {
      $specialist_terms[] = ['target_id' => $term_id];
    }
    $paragraph->get('field_library_specialist')->setValue($specialist_terms);

    $staff_photo = [];
    $dom = new DOMDocument();
    $dom->loadHTML($data->field_user_photo_display);
    foreach ($dom->getElementsByTagName('img') as $i => $img) {
      $staff_photo[] = $img->getAttribute('src');
    }
    if (count($staff_photo) > 1) {
      $users_error[] = Markup::create('<p>More than one photo for '.$data->uniqname.'</p>');
      custom_uml_mail_send_mail($recipient, $reply_to, 'Extra photo!', $users_error, 'custom_subsites_users_report');
    }
    $staff_media = _custom_user_feed_do_file_to_media($staff_photo[0]);
    $paragraph->get('field_media_image')->setValue([['target_id' => $staff_media]]);

    if ($data->status == 0 || $data->field_user_non_student_temp == 1 || $data->field_user_student_temp == 1) {
      Drush::output()->writeln('Removing '.$data->uniqname);
      $users_report[] = Markup::create('<p>Removing '.$data->uniqname.'</p>');
      $delete_media = Media::load($staff_media);
      $delete_file_id = $delete_media->get('field_media_image')->target_id;
      $delete_file = File::load($delete_file_id);

      $p_results = _custom_user_feed_check_references('paragraph', $paragraph->id());
      $spec_references = \Drupal::entityQuery('paragraph')
        ->accessCheck(FALSE)
        ->condition('type', 'course_specialist')
        ->condition('field_course_specialist', $paragraph->get('field_uniqname')->value)
        ->execute();
      if (empty($p_results) && empty($spec_references)) {
        Drush::output()->writeln('Deleting paragraph for '.$data->uniqname);
        $paragraph->delete();
      }
      else {
        Drush::output()->writeln('Unpublishing paragraph for '.$data->uniqname.' since some data may be in use.');
        $paragraph->setUnpublished()->save();
      }

      $m_results = _custom_user_feed_check_references('media', $delete_media->id());
      if (empty($m_results)) {
        Drush::output()->writeln('Deleting media for '.$data->uniqname);
        $delete_media->delete();
      }
      else {
        Drush::output()->writeln('Unpublishing media for '.$data->uniqname.' since some data may be in use.');
        $delete_media->setUnpublished()->save();
      }

      $verify_file = \Drupal::getContainer()->get('file.usage')->listUsage($delete_file);
      if (empty($verify_file)) {
        Drush::output()->writeln('Deleting file for '.$data->uniqname);
        $delete_file->delete();
      }
    }
    else {
      Drush::output()->writeln('Updated '.$data->uniqname);
      $users_report[] = Markup::create('<p>Updated '.$data->uniqname.'</p>');
      $paragraph->setPublished()->save();
    }
  }

  custom_uml_mail_send_mail($recipient, $reply_to, 'Subsite User Report', $users_report, 'custom_subsites_users_report');
}

function _custom_user_feed_check_references($target_type, $id) {
  $map = \Drupal::service('entity_field.manager')->getFieldMap();
  $results = [];
  foreach ($map as $entity_type => $fields) {
    foreach ($fields as $field_name => $field) {
      $config = FieldStorageConfig::loadByName($entity_type, $field_name);
      if ($config && $config->getSetting('target_type') == $target_type) {
        $ids = \Drupal::entityQuery($entity_type)
          ->accessCheck(FALSE)
          ->condition($field_name, $id)
          ->execute();

        if (!empty($ids)) {
          $results[$entity_type][$field_name] = $ids;
        }
      }
    }
  }

  return $results;
}

function _custom_user_feed_do_file_to_media($url) {
  $url = 'https://staff.lib.umich.edu'.$url;
  $file_scheme = \Drupal::config('system.file')->get('default_scheme') . "://";
  $files_dir = \Drupal::service('file_system')->realpath($file_scheme);
  $file_path = 'staff_photos/';
  $file_name = basename($url);

  $downloaded_file = $files_dir.'/'.$file_path.$file_name;
  if (!file_exists($downloaded_file)) {
    $data = file_get_contents($url);
    if (!$data) {
      $recipient = 'eliotwsc@umich.edu';
      $reply_to = \Drupal::config('system.site')->get('mail');
      $users_error[] = Markup::create('<p>Photo error for '.$url.'</p>');
      custom_uml_mail_send_mail($recipient, $reply_to, 'File is missing!', $users_error, 'custom_subsites_users_report');
    }
    file_put_contents($downloaded_file, $data);
    chmod($downloaded_file, 0664);
    chgrp($downloaded_file, 'www-data');
  }

  $public_uri = $file_scheme.$file_path.$file_name;
  $file_repository = \Drupal::service('file.repository');
  $file = $file_repository->loadByUri($public_uri);

  if (!$file) {
    $file = File::create([
      'uid' => 1,
      'filename' => $file_name,
      'uri' => $public_uri,
      'filemime' => \Drupal::service('file.mime_type.guesser')->guessMimeType($downloaded_file),
      'filesize' => filesize($downloaded_file),
      'status' => 1,
    ]);
    $file->save();
  }

  $media_query = \Drupal::entityQuery('media')
    ->accessCheck(FALSE)
    ->condition('bundle', 'staff_photo')
    ->condition('field_media_image', $file->id());
  $check_media = $media_query->execute();
  $id = 0;
  if (empty($check_media)) {
    $media_entity = Media::create([
      'bundle' => 'staff_photo',
      'uid' => '1',
      'name' => $file->getFilename(),
      'status' => 1,
      'field_media_image' => [
        'target_id' => $file->id(),
        'alt' => $file->alt,
      ],
    ]);
    $media_entity->save();
    $id = $media_entity->id();
  }
  else {
    $id = array_values($check_media)[0];
  }

  return $id;

}
